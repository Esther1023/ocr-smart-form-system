<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esther的工作助理</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Esther的工作助理</h1>
        </div>

        <div class="card">
            <form id="contractForm" enctype="multipart/form-data" method="post" action="/generate">
                <div class="form-group">
                    <label for="fileInput">快速选择模板</label>
                    <div class="template-buttons">
                        <button type="button" class="btn btn-template" data-template="标准版合同模板_带变量.docx">标准版</button>
                        <button type="button" class="btn btn-template" data-template="企业版合同模板_带变量.docx">企业版</button>
                        <button type="button" class="btn btn-template" data-template="定制版合同模板_带变量.docx">定制版</button>
                        <button type="button" class="btn btn-template" data-template="青春版合同模板_带变量.docx">青春版</button>
                        <button type="button" class="btn btn-template" data-template="专业版合同模板_带变量.docx">专业版</button>
                    </div>
                </div>
                <input type="file" name="template" accept=".docx" required class="file-input" id="fileInput"
                    style="display: none;">
                <div class="file-info" id="fileInfo" style="display: none;"></div>

                <!-- 甲方基本信息 section -->
                <div class="form-section">
                    <h3>甲方基本信息</h3>
                    <div class="variables-form">
                        <div class="form-group full-width">
                            <label for="imageUploadArea">智能表单填充（拖拽或粘贴截图自动识别）</label>
                            <div class="image-upload-container">
                                <div class="image-upload-area" id="imageUploadArea">
                                    <div class="upload-content">
                                        <div class="upload-icon">📷</div>
                                        <div class="upload-text">
                                            <p>拖拽图片到此处或点击上传</p>
                                            <p class="upload-hint">支持 PNG、JPG、JPEG 等格式，最大 10MB</p>
                                            <p class="upload-hint">也可以直接粘贴剪贴板中的截图（Ctrl+V / Cmd+V）</p>
                                        </div>
                                    </div>
                                    <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                                </div>
                                <div class="image-preview" id="imagePreview" style="display: none;">
                                    <img id="previewImage" src="" alt="预览图片">
                                    <div class="preview-actions">
                                        <button type="button" class="btn btn-secondary" id="clearImageBtn">清除图片</button>
                                    </div>
                                </div>
                                <div class="ocr-progress" id="ocrProgress" style="display: none;">
                                    <div class="progress-bar">
                                        <div class="progress-fill"></div>
                                    </div>
                                    <p class="progress-text">正在识别图片中的文字...</p>
                                </div>
                                <div class="ocr-result" id="ocrResult" style="display: none;">
                                    <!-- 简化的结果显示，主要用于错误处理 -->
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="company_name">账号-企业名称（必填）</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="company_name" id="company_name" required
                                    oninput="debounceQueryByCompanyName(event)" placeholder="输入2个字符以上开始搜索">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tax_number">税号（必填）</label>
                            <input type="text" class="form-control" name="tax_number" id="tax_number" required>
                        </div>
                        <div class="form-group">
                            <label for="reg_address">注册地址</label>
                            <input type="text" class="form-control" name="reg_address" id="reg_address">
                        </div>
                        <div class="form-group">
                            <label for="reg_phone">注册电话</label>
                            <input type="text" class="form-control" name="reg_phone" id="reg_phone">
                        </div>
                        <div class="form-group">
                            <label for="bank_name">开户行</label>
                            <input type="text" class="form-control" name="bank_name" id="bank_name">
                        </div>
                        <div class="form-group">
                            <label for="bank_account">账号</label>
                            <input type="text" class="form-control" name="bank_account" id="bank_account">
                        </div>
                        <div class="form-group">
                            <label for="contact_name">联系人</label>
                            <input type="text" class="form-control" name="contact_name" id="contact_name">
                        </div>
                        <div class="form-group">
                            <label for="contact_phone">联系电话</label>
                            <input type="text" class="form-control" name="contact_phone" id="contact_phone">
                        </div>
                        <div class="form-group">
                            <label for="mail_address">邮寄地址</label>
                            <input type="text" class="form-control" name="mail_address" id="mail_address">
                        </div>
                        <div class="form-group">
                            <label for="jdy_account">简道云账号（必填）</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="jdy_account" id="jdy_account" required
                                    oninput="debounceQueryCustomer(event)" placeholder="输入ID显示全部信息">
                                <input type="file" id="excelUpload" accept=".xlsx" style="display: none;">
                                <button type="button" class="btn btn-excel"
                                    onclick="document.getElementById('excelUpload').click()">导入Excel</button>
                                <button type="button" class="btn btn-shortcut" id="btn-hetiao-inline">朕的业绩</button>
                                <button type="button" class="btn btn-shortcut" id="btn-sa-inline">SA后台</button>
                                <button type="button" class="btn btn-shortcut" id="btn-huikuan-inline">查查回款</button>
                                <button type="button" class="btn btn-shortcut" id="btn-xiadan-inline">记得接口</button>
                                <button type="button" class="btn btn-shortcut" id="btn-qiwei-inline">KMS</button>
                                <button type="button" class="btn btn-shortcut" id="btn-daike-inline">KA看板</button>
                                <span id="lastImportTime" class="last-import-time"></span>
                            </div>
                        </div>
                        <div id="customerInfo" class="form-group full-width" style="display: none;">
                            <div class="customer-info-box">
                                <div class="info-row">
                                    <label>账号-企业名称：</label>
                                    <span id="accountCompanyName"></span>
                                </div>
                                <div class="info-row">
                                    <label>集成模式：</label>
                                    <span id="integrationMode"></span>
                                </div>
                                <div class="info-row">
                                    <label>到期日期：</label>
                                    <span id="expiryDate"></span>
                                </div>
                                <div class="info-row">
                                    <label>应续ARR：</label>
                                    <span id="uidArr"></span>
                                </div>
                                <div class="info-row">
                                    <label>客户分类：</label>
                                    <span id="customerClassification"></span>
                                </div>
                                <div class="info-row">
                                    <label>续费责任销售：</label>
                                    <span id="renewalSales"></span>
                                </div>
                                <div class="info-row">
                                    <label>责任销售中英文：</label>
                                    <span id="salesChineseEnglish"></span>
                                </div>
                                <div class="info-row">
                                    <label>简道云销售：</label>
                                    <span id="jiandaoyunSales"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 服务期限与费用信息 section -->
                <div class="form-section">
                    <h3>服务期限与费用信息</h3>
                    <div class="variables-form">
                        <!-- 服务期限子区域 -->
                        <div class="form-subsection">
                            <h4 class="subsection-title">服务期限</h4>
                            <div class="subsection-fields">
                                <div class="form-group service-duration-group">
                                    <label>服务期限（必填）</label>
                                    <div class="duration-inputs">
                                        <div class="duration-input-item">
                                            <label for="serviceYears">年份</label>
                                            <input type="number" class="form-control" name="service_years" required min="0"
                                                id="serviceYears" placeholder="0">
                                        </div>
                                        <div class="duration-input-item">
                                            <label for="serviceMonths">额外月份</label>
                                            <input type="number" class="form-control" name="service_months" min="0" max="23"
                                                id="serviceMonths" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="duration-summary" id="durationSummary">
                                        总计：0年0个月
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="startYear">开始年份（必填）</label>
                                    <input type="number" class="form-control" name="start_year" required id="startYear">
                                </div>
                                <div class="form-group">
                                    <label for="startMonth">开始月份（必填）</label>
                                    <input type="number" class="form-control" name="start_month" min="1" max="12" required
                                        id="startMonth">
                                </div>
                                <div class="form-group">
                                    <label for="startDay">开始日期（必填）</label>
                                    <input type="number" class="form-control" name="start_day" min="1" max="31" required
                                        id="startDay">
                                </div>
                                <div class="form-group">
                                    <label for="endYear">结束年份（自动计算）</label>
                                    <input type="number" class="form-control" name="end_year" required readonly id="endYear">
                                </div>
                                <div class="form-group">
                                    <label for="endMonth">结束月份（自动计算）</label>
                                    <input type="number" class="form-control" name="end_month" min="1" max="12" required
                                        readonly id="endMonth">
                                </div>
                                <div class="form-group">
                                    <label for="endDay">结束日期（自动计算）</label>
                                    <input type="number" class="form-control" name="end_day" min="1" max="31" required readonly
                                        id="endDay">
                                </div>
                            </div>
                        </div>

                        <!-- 费用信息子区域 -->
                        <div class="form-subsection">
                            <h4 class="subsection-title">费用信息</h4>
                            <div class="subsection-fields">
                                <div class="form-group">
                                    <label for="totalAmount">服务费用金额（数字）</label>
                                    <input type="number" class="form-control" name="total_amount" required id="totalAmount"
                                        step="0.01" min="0" pattern="[0-9]+(\.[0-9]{1,2})?"
                                        oninput="calculateUnitPrice()">
                                </div>
                                <div class="form-group">
                                    <label for="user_count">使用人数</label>
                                    <input type="number" class="form-control" name="user_count" id="user_count" required min="1"
                                        step="1" pattern="[0-9]+" oninput="calculateUnitPrice()">
                                </div>
                                <div class="form-group">
                                    <label for="unitPrice">单价（元/人/年）</label>
                                    <input type="number" class="form-control" name="unit_price" required id="unitPrice"
                                        step="0.01" min="0" pattern="[0-9]+(\.[0-9]{1,2})?"
                                        oninput="calculateTotalAmount()">
                                </div>
                                <div class="form-group full-width">
                                    <label for="totalAmountCn">服务费用金额（大写，自动生成）</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="total_amount_cn" required readonly
                                            id="totalAmountCn">
                                        <button type="button" class="btn btn-secondary" onclick="fillTestData()">填充测试数据</button>
                                        <button type="submit" class="btn btn-generate">生成合同</button>
                                    </div>
                                </div>
                                <input type="hidden" name="payment_amount" id="paymentAmount">
                                <input type="hidden" name="payment_amount_cn" id="paymentAmountCn">
                            </div>
                        </div>
                    </div>
                </div>


            </form>
        </div>
    </div>

    <script src="/static/script.js"></script>
    <script>
        // 填充测试数据
        function fillTestData() {
            // 填充甲方基本信息
            document.querySelector('[name="company_name"]').value = '测试科技有限公司';
            document.querySelector('[name="tax_number"]').value = '91330000123456789X';
            document.querySelector('[name="reg_address"]').value = '浙江省杭州市西湖区测试路88号';
            document.querySelector('[name="reg_phone"]').value = '0571-88888888';
            document.querySelector('[name="bank_name"]').value = '中国测试银行杭州分行';
            document.querySelector('[name="bank_account"]').value = '1234567890123456789';
            document.querySelector('[name="contact_name"]').value = '张测试';
            document.querySelector('[name="contact_phone"]').value = '13800138000';
            document.querySelector('[name="mail_address"]').value = '浙江省杭州市西湖区测试路88号';
            document.querySelector('[name="jdy_account"]').value = '12345678abcdefghijklmnop';

            // 填充服务期限
            document.getElementById('serviceYears').value = '2';
            document.getElementById('serviceMonths').value = '6';
            document.getElementById('startYear').value = '2025';
            document.getElementById('startMonth').value = '3';
            document.getElementById('startDay').value = '6';

            // 触发自动计算
            processDurationInput();

            // 填充费用信息
            document.getElementById('totalAmount').value = '125680.50';
            document.querySelector('[name="user_count"]').value = '50';
            // 触发自动计算单价
            calculateUnitPrice();


        }

        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');

        // 数字转中文大写
        function numberToChinese(num) {
            if (num === 0) {
                return '零元整';
            }

            const chineseNums = ['零', '壹', '贰', '叁', '肆', '伍', '陆', '柒', '捌', '玖'];
            const units = ['', '拾', '佰', '仟'];
            const bigUnits = ['', '万', '亿'];

            num = Math.floor(num);
            let strArr = [];
            let current = num;
            let level = 0;

            while (current > 0) {
                let section = current % 10000;
                let sectionStr = '';
                let hasValue = false;
                let lastHasValue = false;

                for (let i = 0; i < 4; i++) {
                    const digit = section % 10;

                    if (digit === 0) {
                        if (lastHasValue && section > 0) {
                            sectionStr = '零' + sectionStr;
                        }
                        lastHasValue = false;
                    } else {
                        sectionStr = chineseNums[digit] + units[i] + sectionStr;
                        hasValue = true;
                        lastHasValue = true;
                    }

                    section = Math.floor(section / 10);
                }

                if (hasValue) {
                    sectionStr = sectionStr + bigUnits[level] + (strArr.length > 0 ? '零' : '');
                }

                if (sectionStr) {
                    strArr.unshift(sectionStr.replace(/零+$/, '').replace(/零+/g, '零'));
                }

                current = Math.floor(current / 10000);
                level++;
            }

            let result = strArr.join('').replace(/零+$/, '');
            return result + '元整';
        }

        // 更新中文金额
        function updateChineseAmount(value) {
            const num = parseFloat(value) || 0;
            document.getElementById('totalAmountCn').value = numberToChinese(num);
            document.getElementById('paymentAmount').value = num;
            document.getElementById('paymentAmountCn').value = numberToChinese(num);
        }

        // 精确的数值四舍五入函数
        function roundToTwo(num) {
            return Math.round((num + Number.EPSILON) * 100) / 100;
        }

        // 计算单价
        function calculateUnitPrice() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            const userCount = parseFloat(document.querySelector('[name="user_count"]').value) || 0;
            const serviceYears = getTotalServiceYears();

            if (totalAmount && userCount && serviceYears > 0) {
                const unitPrice = totalAmount / (userCount * serviceYears);
                const roundedUnitPrice = roundToTwo(unitPrice);
                document.getElementById('unitPrice').value = roundedUnitPrice.toFixed(2);
                updateChineseAmount(totalAmount);
            }
        }

        // 根据单价计算总金额
        function calculateTotalAmount() {
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            const userCount = parseFloat(document.querySelector('[name="user_count"]').value) || 0;
            const serviceYears = getTotalServiceYears();

            if (unitPrice && userCount && serviceYears > 0) {
                const totalAmount = unitPrice * userCount * serviceYears;
                const roundedTotalAmount = roundToTwo(totalAmount);
                document.getElementById('totalAmount').value = roundedTotalAmount.toFixed(2);
                updateChineseAmount(roundedTotalAmount);
            }
        }

        // 处理年月输入并自动转换
        function processDurationInput() {
            const yearsInput = document.getElementById('serviceYears');
            const monthsInput = document.getElementById('serviceMonths');
            const summaryDiv = document.getElementById('durationSummary');

            if (!yearsInput || !monthsInput || !summaryDiv) {
                return;
            }

            let years = parseInt(yearsInput.value) || 0;
            let months = parseInt(monthsInput.value) || 0;

            // 如果月份≥12，自动转换为年份
            if (months >= 12) {
                const additionalYears = Math.floor(months / 12);
                years += additionalYears;
                months = months % 12;

                // 更新输入框显示
                yearsInput.value = years;
                monthsInput.value = months;
            }

            // 更新总计显示
            summaryDiv.textContent = `总计：${years}年${months}个月`;

            // 计算结束日期
            calculateEndDate();

            // 重新计算费用
            if (document.getElementById('unitPrice').value) {
                calculateTotalAmount();
            } else {
                calculateUnitPrice();
            }
        }

        // 获取总服务期限（以年为单位，包含月份的小数部分）
        function getTotalServiceYears() {
            const years = parseInt(document.getElementById('serviceYears').value) || 0;
            const months = parseInt(document.getElementById('serviceMonths').value) || 0;
            return years + (months / 12);
        }

        // 自动计算结束日期
        function calculateEndDate() {
            const years = parseInt(document.getElementById('serviceYears').value) || 0;
            const months = parseInt(document.getElementById('serviceMonths').value) || 0;
            const startYear = parseInt(document.getElementById('startYear').value) || 0;
            const startMonth = parseInt(document.getElementById('startMonth').value) || 0;
            const startDay = parseInt(document.getElementById('startDay').value) || 0;

            if ((years > 0 || months > 0) && startYear && startMonth && startDay) {
                const endYear = document.getElementById('endYear');
                const endMonth = document.getElementById('endMonth');
                const endDay = document.getElementById('endDay');

                if (!endYear || !endMonth || !endDay) {
                    return;
                }

                // 创建开始日期
                const startDate = new Date(startYear, startMonth - 1, startDay);

                // 添加年份和月份
                const endDate = new Date(startDate);
                endDate.setFullYear(endDate.getFullYear() + years);
                endDate.setMonth(endDate.getMonth() + months);

                // 结束日期为计算日期的前一天
                endDate.setDate(endDate.getDate() - 1);

                endYear.value = endDate.getFullYear();
                endMonth.value = endDate.getMonth() + 1;
                endDay.value = endDate.getDate();
            }
        }

        // 初始化事件监听器
        function initEventListeners() {
            // 检查元素是否存在
            const serviceYears = document.getElementById('serviceYears');
            const serviceMonths = document.getElementById('serviceMonths');
            const startYear = document.getElementById('startYear');
            const startMonth = document.getElementById('startMonth');
            const startDay = document.getElementById('startDay');

            if (!serviceYears || !serviceMonths || !startYear || !startMonth || !startDay) {
                return;
            }

            // 添加服务期限相关字段的事件监听
            serviceYears.addEventListener('input', processDurationInput);
            serviceMonths.addEventListener('input', processDurationInput);

            // 添加开始日期字段的事件监听，用于触发结束日期计算
            startYear.addEventListener('input', calculateEndDate);
            startMonth.addEventListener('input', calculateEndDate);
            startDay.addEventListener('input', calculateEndDate);

            // 添加费用相关字段的事件监听
            const totalAmount = document.getElementById('totalAmount');
            const userCount = document.querySelector('[name="user_count"]');
            const unitPrice = document.getElementById('unitPrice');

            if (totalAmount) {
                totalAmount.addEventListener('input', calculateUnitPrice);
            }
            if (userCount) {
                userCount.addEventListener('input', function () {
                    if (document.getElementById('unitPrice').value) {
                        calculateTotalAmount();
                    } else {
                        calculateUnitPrice();
                    }
                });
            }
            if (unitPrice) {
                unitPrice.addEventListener('input', calculateTotalAmount);
            }
        }

        // 智能图片识别功能
        let currentImageFile = null;
        let recognizedFields = {};

        // 初始化图片上传功能
        function initImageUpload() {
            const uploadArea = document.getElementById('imageUploadArea');
            const fileInput = document.getElementById('imageFileInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            const clearBtn = document.getElementById('clearImageBtn');
            const ocrProgress = document.getElementById('ocrProgress');
            const ocrResult = document.getElementById('ocrResult');

            // 点击上传区域触发文件选择
            uploadArea.addEventListener('click', (e) => {
                // 确保点击的是上传区域本身，不是其他元素
                if (e.target === uploadArea || uploadArea.contains(e.target)) {
                    fileInput.click();
                }
            });

            // 文件选择处理
            fileInput.addEventListener('change', handleFileSelect);

            // 拖拽功能
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            // 粘贴功能 - 改进版本
            document.addEventListener('paste', (e) => {
                // 检查是否在输入框中粘贴
                const activeElement = document.activeElement;
                if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                    return; // 允许在输入框中正常粘贴文本
                }

                const items = e.clipboardData.items;
                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        if (file) {
                            handleFile(file);
                            // 显示提示
                            showPasteSuccess();
                        }
                        break;
                    }
                }
            });

            // 清除图片按钮
            clearBtn.addEventListener('click', clearImage);
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            console.log('处理文件:', file.name, file.type, file.size);

            // 检查文件是否存在
            if (!file) {
                alert('未选择文件');
                return;
            }

            // 检查文件类型
            const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/bmp', 'image/webp', 'image/tiff'];
            if (!allowedTypes.includes(file.type)) {
                alert(`不支持的文件类型: ${file.type}\n请选择有效的图片文件（PNG、JPG、JPEG、GIF、BMP、WebP、TIFF）`);
                return;
            }

            // 检查文件大小（10MB限制）
            if (file.size > 10 * 1024 * 1024) {
                alert(`文件大小过大: ${(file.size / 1024 / 1024).toFixed(2)}MB\n请选择小于10MB的文件`);
                return;
            }

            console.log('文件验证通过，开始处理');
            currentImageFile = file;
            showImagePreview(file);

            // 自动开始识别
            setTimeout(() => {
                processImage();
            }, 800);
        }

        function showImagePreview(file) {
            console.log('显示图片预览');
            const uploadArea = document.getElementById('imageUploadArea');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');

            const reader = new FileReader();
            reader.onload = (e) => {
                console.log('图片读取完成');
                previewImage.src = e.target.result;
                uploadArea.style.display = 'none';
                imagePreview.style.display = 'block';
            };
            reader.onerror = (e) => {
                console.error('图片读取失败:', e);
                alert('图片读取失败，请重试');
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            console.log('清除图片');
            currentImageFile = null;
            recognizedFields = {};

            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('ocrProgress').style.display = 'none';
            document.getElementById('ocrResult').style.display = 'none';
            document.getElementById('imageFileInput').value = '';

            resetUploadArea();
        }

        function showPasteSuccess() {
            // 创建临时提示
            const uploadArea = document.getElementById('imageUploadArea');
            const originalContent = uploadArea.innerHTML;

            uploadArea.innerHTML = `
                <div class="upload-content">
                    <div class="upload-icon">✅</div>
                    <div class="upload-text">
                        <p>图片粘贴成功！</p>
                        <p class="upload-hint">正在处理...</p>
                    </div>
                </div>
            `;

            // 2秒后恢复原内容
            setTimeout(() => {
                uploadArea.innerHTML = originalContent;
            }, 2000);
        }

        function processImage() {
            console.log('开始处理图片');

            if (!currentImageFile) {
                alert('请先选择图片');
                return;
            }

            const ocrProgress = document.getElementById('ocrProgress');
            const ocrResult = document.getElementById('ocrResult');

            // 显示进度条
            ocrProgress.style.display = 'block';
            ocrResult.style.display = 'none';

            // 创建FormData
            const formData = new FormData();
            formData.append('image', currentImageFile);

            console.log('发送OCR请求，文件大小:', currentImageFile.size);

            // 发送OCR请求
            fetch('/ocr_process', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('收到响应:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('OCR响应数据:', data);
                ocrProgress.style.display = 'none';

                if (data.success) {
                    recognizedFields = data.parsed_fields;
                    console.log('识别到字段:', Object.keys(data.parsed_fields).length);
                    // 显示简化的成功提示并直接填充
                    showOCRSuccess(data);
                } else {
                    console.error('OCR识别失败:', data.error);

                    // 检查是否是OCR不可用的错误
                    if (data.ocr_available === false || data.tesseract_available === false) {
                        showOCRUnavailable(data.error);
                    } else {
                        alert('图片识别失败：' + (data.error || '未知错误'));
                        resetUploadArea();
                    }
                }
            })
            .catch(error => {
                ocrProgress.style.display = 'none';
                console.error('OCR请求失败:', error);
                alert('网络请求失败：' + error.message + '\n请检查网络连接并重试');
                resetUploadArea();
            });
        }

        function showOCRSuccess(data) {
            const uploadArea = document.getElementById('imageUploadArea');
            const imagePreview = document.getElementById('imagePreview');
            const ocrResult = document.getElementById('ocrResult');

            // 隐藏图片预览
            imagePreview.style.display = 'none';

            // 应用字段到表单
            const result = applyFieldsToFormDirectly(data.parsed_fields);

            // 显示成功消息
            uploadArea.innerHTML = `
                <div class="upload-content">
                    <div class="upload-icon">✅</div>
                    <div class="upload-text">
                        <p><strong>识别成功！</strong></p>
                        <p>已自动填充 ${result.appliedCount} 个字段到表单</p>
                        <p class="upload-hint">您可以直接在表单中编辑这些字段</p>
                    </div>
                </div>
            `;
            uploadArea.style.display = 'block';

            // 隐藏OCR结果区域（不再需要）
            ocrResult.style.display = 'none';

            // 3秒后恢复上传区域
            setTimeout(() => {
                resetUploadArea();
            }, 3000);
        }

        function resetUploadArea() {
            const uploadArea = document.getElementById('imageUploadArea');
            uploadArea.innerHTML = `
                <div class="upload-content">
                    <div class="upload-icon">📷</div>
                    <div class="upload-text">
                        <p>拖拽图片到此处或点击上传</p>
                        <p class="upload-hint">支持 PNG、JPG、JPEG 等格式，最大 10MB</p>
                        <p class="upload-hint">也可以直接粘贴剪贴板中的截图（Ctrl+V / Cmd+V）</p>
                    </div>
                </div>
            `;
            currentImageFile = null;
        }

        function showOCRUnavailable(errorMessage) {
            const uploadArea = document.getElementById('imageUploadArea');
            const imagePreview = document.getElementById('imagePreview');

            // 隐藏图片预览
            imagePreview.style.display = 'none';

            // 显示OCR不可用的详细信息
            uploadArea.innerHTML = `
                <div class="upload-content">
                    <div class="upload-icon">⚠️</div>
                    <div class="upload-text">
                        <p><strong>OCR功能不可用</strong></p>
                        <p class="upload-hint">需要安装OCR依赖包才能识别图片中的文字</p>
                        <div style="margin-top: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 4px; text-align: left; font-size: 12px;">
                            <p><strong>安装步骤：</strong></p>
                            <p>1. 安装Tesseract OCR引擎：</p>
                            <code>brew install tesseract tesseract-lang</code>
                            <p>2. 安装Python依赖包：</p>
                            <code>pip install pytesseract pillow opencv-python</code>
                            <p>3. 重启应用</p>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="resetUploadArea()" style="margin-top: 10px;">返回上传</button>
                    </div>
                </div>
            `;
            uploadArea.style.display = 'block';
        }

        function getFieldLabel(fieldName) {
            const labels = {
                'company_name': '账号-企业名称',
                'tax_number': '税号',
                'reg_address': '注册地址',
                'reg_phone': '注册电话',
                'bank_name': '开户行',
                'bank_account': '银行账号',
                'contact_name': '联系人',
                'contact_phone': '联系电话',
                'mail_address': '邮寄地址',
                'jdy_account': '简道云账号'
            };
            return labels[fieldName] || fieldName;
        }

        // 内联编辑功能
        function startInlineEdit(element) {
            if (element.classList.contains('editing')) {
                return; // 已经在编辑状态
            }

            const fieldName = element.getAttribute('data-field');
            const currentValue = element.textContent;

            // 添加编辑状态样式
            element.classList.add('editing');

            // 创建输入框
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'field-value-input';
            input.value = currentValue;

            // 替换内容
            element.innerHTML = '';
            element.appendChild(input);

            // 聚焦并选中文本
            input.focus();
            input.select();

            // 保存编辑
            function saveEdit() {
                const newValue = input.value.trim();
                if (newValue !== currentValue) {
                    recognizedFields[fieldName] = newValue;
                }

                // 恢复显示
                element.classList.remove('editing');
                element.textContent = newValue || currentValue;
                element.onclick = () => startInlineEdit(element);
            }

            // 取消编辑
            function cancelEdit() {
                element.classList.remove('editing');
                element.textContent = currentValue;
                element.onclick = () => startInlineEdit(element);
            }

            // 事件监听
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });

            // 移除点击事件，避免重复触发
            element.onclick = null;
        }

        // 直接应用字段到表单（新的简化流程）
        function applyFieldsToFormDirectly(fields) {
            let appliedCount = 0;
            const appliedFields = [];

            for (const [fieldName, value] of Object.entries(fields)) {
                const formField = document.querySelector(`[name="${fieldName}"]`);
                if (formField && value.trim()) {
                    formField.value = value.trim();
                    // 添加视觉反馈
                    formField.classList.add('auto-filled');
                    setTimeout(() => {
                        formField.classList.remove('auto-filled');
                    }, 3000);
                    appliedCount++;
                    appliedFields.push(getFieldLabel(fieldName));
                }
            }

            if (appliedCount > 0) {
                // 触发相关事件（如账号-企业名称查询）
                const companyNameField = document.querySelector('[name="company_name"]');
                if (companyNameField && companyNameField.value) {
                    // 触发账号-企业名称查询
                    setTimeout(() => {
                        const event = new Event('input', { bubbles: true });
                        companyNameField.dispatchEvent(event);
                    }, 500);
                }
            }

            return { appliedCount, appliedFields };
        }

        // 保留原有的应用函数（用于手动应用）
        function applyFieldsToForm() {
            const result = applyFieldsToFormDirectly(recognizedFields);
            if (result.appliedCount > 0) {
                alert(`成功应用 ${result.appliedCount} 个字段到表单`);
            } else {
                alert('没有可应用的字段');
            }
        }

        // 显示/隐藏原始文本
        function toggleRawText() {
            const rawTextDiv = document.getElementById('rawText');
            const btn = document.getElementById('showRawTextBtn');

            if (rawTextDiv.style.display === 'none') {
                rawTextDiv.style.display = 'block';
                btn.textContent = '隐藏原文';
            } else {
                rawTextDiv.style.display = 'none';
                btn.textContent = '查看原文';
            }
        }

        // 初始化所有事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            console.log('初始化智能表单填充功能');
            initImageUpload();
        });

        // 模板选择功能
        document.querySelectorAll('.btn-template').forEach(button => {
            button.addEventListener('click', function () {
                const templateName = this.dataset.template;

                // 移除其他按钮的active状态
                document.querySelectorAll('.btn-template').forEach(btn => {
                    btn.classList.remove('active');
                });

                // 添加当前按钮的active状态
                this.classList.add('active');

                // 从服务器获取模板文件
                fetch(`/docx_templates/${templateName}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`模板文件获取失败: ${response.status}`);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // 创建文件对象
                        const file = new File([blob], templateName, {
                            type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                        });
                        
                        // 设置到文件输入框
                        const fileInput = document.getElementById('fileInput');
                        
                        // 使用 DataTransfer API
                        try {
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            fileInput.files = dataTransfer.files;
                        } catch (error) {
                            console.error('文件设置失败:', error);
                            alert('文件设置失败，请手动上传文件');
                        }
                    })
                    .catch(error => {
                        console.error('模板加载失败:', error);
                        alert('模板加载失败，请检查模板文件是否存在或手动上传文件');
                    });
            });
        });





        // 检查并显示最后导入时间
        fetch('/get_last_import_time')
            .then(response => response.json())
            .then(data => {
                if (data.last_import_time) {
                    document.getElementById('lastImportTime').textContent = `最后导入: ${data.last_import_time}`;
                }
            });

        // Excel文件上传处理
        document.getElementById('excelUpload').addEventListener('change', function (e) {
            if (!this.files.length) return;

            const file = this.files[0];
            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload_excel', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        document.getElementById('lastImportTime').textContent = `最后导入: ${data.last_import_time}`;
                        alert('Excel文件导入成功');
                    }
                })
                .catch(error => {
                    alert('文件上传失败: ' + error);
                });

            // 清除文件选择，允许重复选择同一文件
            this.value = '';
        });

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 客户查询功能
        const debounceQueryCustomer = debounce((event) => {
            const jdyAccount = event.target.value;
            if (jdyAccount.length < 3) return; // 至少输入3个字符才开始查询
            queryCustomer(jdyAccount);
        }, 500); // 500ms 防抖

        async function queryCustomer(jdyAccount) {
            try {
                console.log('查询简道云账号:', jdyAccount); // 调试输出
                const response = await fetch('/query_customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ jdy_id: jdyAccount })
                });

                console.log('响应状态:', response.status); // 调试输出

                if (!response.ok) {
                    const error = await response.json();
                    console.error('查询错误:', error); // 调试输出
                    throw new Error(error.error || '查询失败');
                }

                const data = await response.json();
                console.log('查询结果:', data); // 调试输出

                if (!data.results || data.results.length === 0) {
                    throw new Error('未找到客户信息');
                }

                // 使用第一个匹配结果
                const customerData = data.results[0];

                // 显示客户信息
                document.getElementById('accountCompanyName').textContent = customerData.account_company_name || '';
                document.getElementById('integrationMode').textContent = customerData.integration_mode || '';
                document.getElementById('expiryDate').textContent = customerData.expiry_date || '';
                document.getElementById('uidArr').textContent = customerData.uid_arr || '';
                document.getElementById('customerClassification').textContent = customerData.customer_classification || '';
                document.getElementById('renewalSales').textContent = customerData.renewal_sales || '';
                document.getElementById('salesChineseEnglish').textContent = customerData.sales_chinese_english || '';
                document.getElementById('jiandaoyunSales').textContent = customerData.jiandaoyun_sales || '';

                // 自动填充账号-企业名称
                document.querySelector('[name="company_name"]').value = customerData.account_company_name || '';

                // 显示客户信息框
                document.getElementById('customerInfo').style.display = 'block';
            } catch (error) {
                alert(error.message);
                document.getElementById('customerInfo').style.display = 'none';
            }
        }

        // 客户查询功能（通过账号-企业名称）
        const debounceQueryByCompanyName = debounce((event) => {
            const companyName = event.target.value;
            if (companyName.length < 2) return; // 至少输入2个字符才开始查询
            queryByCompanyName(companyName);
        }, 500); // 500ms 防抖

        async function queryByCompanyName(companyName) {
            try {
                console.log('查询账号-企业名称:', companyName); // 调试输出
                const response = await fetch('/query_customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ company_name: companyName })
                });

                console.log('响应状态:', response.status); // 调试输出

                if (!response.ok) {
                    const error = await response.json();
                    console.error('查询错误:', error); // 调试输出
                    throw new Error(error.error || '查询失败');
                }

                const data = await response.json();
                console.log('查询结果:', data); // 调试输出

                if (!data.results || data.results.length === 0) {
                    throw new Error('未找到客户信息');
                }

                // 使用第一个匹配结果
                const customerData = data.results[0];

                // 显示客户信息并自动填充相关字段
                updateCustomerInfo(customerData);
            } catch (error) {
                alert(error.message);
                document.getElementById('customerInfo').style.display = 'none';
            }
        }

        // 更新客户信息显示
        function updateCustomerInfo(customerData) {
            // 显示客户信息
            document.getElementById('accountCompanyName').textContent = customerData.account_company_name || '';
            document.getElementById('integrationMode').textContent = customerData.integration_mode || '';
            document.getElementById('expiryDate').textContent = customerData.expiry_date || '';
            document.getElementById('uidArr').textContent = customerData.uid_arr || '';
            document.getElementById('customerClassification').textContent = customerData.customer_classification || '';
            document.getElementById('renewalSales').textContent = customerData.renewal_sales || '';
            document.getElementById('salesChineseEnglish').textContent = customerData.sales_chinese_english || '';
            document.getElementById('jiandaoyunSales').textContent = customerData.jiandaoyun_sales || '';

            // 自动填充简道云账号
            if (customerData.jiandaoyun_sales) {
                document.querySelector('[name="jdy_account"]').value = customerData.jiandaoyun_sales;
            }

            // 显示客户信息框
            document.getElementById('customerInfo').style.display = 'block';
        }

        document.getElementById('contractForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const templateFile = document.querySelector('input[type="file"]').files[0];
            if (!templateFile) {
                alert('请选择合同模板文件');
                return;
            }
            
            // 创建FormData对象并添加所有表单数据
            const formData = new FormData(this);
            
            // 确保文件和其他必要字段都已添加
            if (!formData.has('template')) {
                formData.append('template', templateFile);
            }
            
            // 提交表单
            // 提交表单
            fetch('/generate', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('服务器响应错误:', response.status, text);
                        // 尝试解析JSON错误信息
                        try {
                            const errorObj = JSON.parse(text);
                            throw new Error(errorObj.error || `服务器错误 (${response.status}): ${text}`);
                        } catch (e) {
                            // 如果不是JSON，直接显示文本
                            throw new Error(`服务器错误 (${response.status}): ${text}`);
                        }
                    });
                }
                return response.blob();
            })
            .then(blob => {
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                
                // 设置文件名
                const companyName = document.querySelector('[name="company_name"]').value;
                const startYear = document.getElementById('startYear').value;
                const endYear = document.getElementById('endYear').value;
                const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                
                // 新的文件命名格式：开始年份-结束年份+账号-企业名称+帆软简道云续费合同+合同生成日期
                a.download = `${startYear}-${endYear}${companyName}-帆软简道云续费合同${currentDate}.docx`;
                
                // 触发下载
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('生成合同失败:', error);
                alert('生成合同失败: ' + error.message);
            });
        });

        // 初始化
        initEventListeners();
    </script>
</body>

</html>